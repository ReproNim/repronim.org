{{ $category := .Get "category" }}
{{ $elementId := .Get "id" }}
{{ $linkUrl := .Get "linkurl" | default "https://repronim.wordpress.com/" }}
{{ $linkText := .Get "linktext" | default "posts" }}
{{ $showExcerpt := .Get "showexcerpt" | default false }}
{{ $stripTitlePrefix := .Get "striptitleprefix" | default "" }}
{{ $numEntries := .Get "numentries" | default 10 }}

<div id="{{ $elementId }}">
See <a href="{{ $linkUrl }}">our {{ $linkText }}</a>.
</div>

<script defer>
(function() {
    var posts_div = document.getElementById("{{ $elementId }}");

    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
        // wait for DONE
        if(req.readyState != 4) {
            return;
        }
        if(req.status == 200) {
            var posts = JSON.parse(req.responseText);
            posts_div.innerHTML = "";
            var ul = document.createElement("ul");
            posts_div.appendChild(ul);
            var n_items = 0;
            for(var i = 0;i < posts.length;i++) {
                var a = document.createElement("a");
                a.href = posts[i].link;
                a.target = "_blank";
                var li = document.createElement("li");
                li.appendChild(a)
                {{ if $stripTitlePrefix }}
                a.innerHTML = posts[i].title.rendered.replace(/^{{ $stripTitlePrefix }}:?\s*/i, "");
                {{ else }}
                a.innerHTML = posts[i].title.rendered;
                {{ end }}
                {{ if $showExcerpt }}
                if(posts[i].excerpt.rendered.length < 500) {
                    const excerpt = posts[i].excerpt.rendered.replace(/^<p>(.*)<\/p>.*/i, "$1");
                    li.appendChild(document.createTextNode(" " + excerpt));
                }
                {{ end }}
                var date = new Date(posts[i].date);
                li.appendChild(document.createTextNode(" (" + date.toLocaleDateString() + ")"));
                ul.appendChild(li);
                n_items++;
            }
        var p = document.createElement("p");
        p.innerHTML = '<a href="{{ $linkUrl }}" target="_blank">See all {{ $linkText }}</a>.';
        posts_div.appendChild(p);
        }
    }

    // limit list length with paginated request with category filter
    req.open("GET", "https://public-api.wordpress.com/wp/v2/sites/repronim.wordpress.com/posts?categories={{ $category }}&per_page={{ $numEntries }}", true);
    req.send();
})();
</script>
